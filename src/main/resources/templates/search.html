<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Search Items</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    main {
      flex: 1;
    }
    footer {
      margin-top: auto;
    }
    .search-card img {
      width: 100%;
      height: 300px;
      object-fit: cover;
      border-top-left-radius: .5rem;
      border-top-right-radius: .5rem;
    }
  </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container">
    <a class="navbar-brand" href="#">
      <img src="/images/logo.png" alt="Logo" width="220" height="40">
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="/index">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="/report">Report</a></li>
        <li class="nav-item"><a class="nav-link active" href="/search">Search</a></li>
        <li class="nav-item"><a class="nav-link" href="/dashboard">Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" href="/matches">Matches</a></li>

        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="profileDropdown"
             role="button" data-bs-toggle="dropdown" aria-expanded="false">
            <img src="/images/Profile.png" alt="Profile" width="30" height="30" class="rounded-circle">
          </a>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#profileModal" onclick="loadProfile()">My Profile</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item text-danger" href="/logout" id="logoutBtn">Logout</a></li>
          </ul>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- Profile Modal -->
<div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="profileModalLabel">My Profile</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="profileDetails">
          <p><strong>Username:</strong> <span id="profileUsername"></span></p>
          <p><strong>Email:</strong> <span id="profileEmail"></span></p>
          <p><strong>Phone:</strong> <span id="profilePhone"></span></p>
        </div>

        <hr>
        <h6>Update Password</h6>
        <form id="updatePasswordForm">
          <div class="mb-3">
            <label for="newPassword" class="form-label">New Password</label>
            <input type="password" class="form-control" id="newPassword" required>
          </div>
          <button type="submit" class="btn btn-primary">Update Password</button>
        </form>
        <div id="updateMessage" class="mt-2"></div>
      </div>
    </div>
  </div>
</div>

<!-- Main Content -->
<main class="container my-5">
  <h2 class="text-center mb-4">Search Items</h2>

  <form class="row g-3 mb-4" id="searchForm">
    <div class="col-md-4">
      <select class="form-select" id="categorySelect">
        <option>All</option>
        <option>Lost</option>
        <option>Found</option>
      </select>
    </div>
    <div class="col-md-4">
      <input type="text" class="form-control" id="locationInput" placeholder="Enter location">
    </div>
    <div class="col-md-4">
      <button type="submit" class="btn btn-primary w-100">Search</button>
    </div>
  </form>

  <div class="row g-4" id="searchResults">
    <!-- Dynamic cards will appear here -->
  </div>
</main>

<!-- Footer -->
<footer class="bg-dark text-light text-center py-3">
  <p>Â© 2025 Lost & Found</p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>

  // Load profile info
  function loadProfile() {
    fetch('/profile/data')
            .then(res => res.json())
            .then(data => {
              document.getElementById('profileUsername').innerText = data.username;
              document.getElementById('profileEmail').innerText = data.email;
              document.getElementById('profilePhone').innerText = data.phone;
            })
            .catch(err => console.error("Profile fetch error:", err));
  }

  // Update password
  document.getElementById('updatePasswordForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const newPassword = document.getElementById('newPassword').value.trim();
    if (!newPassword) return alert("Password cannot be empty.");

    const data = new URLSearchParams();
    data.append('newPassword', newPassword);

    fetch('/profile/update-password', {
      method: 'POST',
      body: data,
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
    })
            .then(res => res.text())
            .then(msg => {
              document.getElementById('updateMessage').innerText = msg;
              document.getElementById('updateMessage').className = msg.toLowerCase().includes("success")
                      ? 'mt-2 text-success' : 'mt-2 text-danger';
              document.getElementById('newPassword').value = '';
            })
            .catch(err => console.error("Password update error:", err));
  });

  // --- Dynamic search ---
  const searchForm = document.getElementById('searchForm');
  const searchResults = document.getElementById('searchResults');

  function loadItems(category = 'all', location = '') {

    fetch(`/api/items/searchItems?status=${encodeURIComponent(category)}&location=${encodeURIComponent(location)}`)
            .then(res => res.json())
            .then(items => {

              searchResults.innerHTML = '';
              if (!items.length)
                return searchResults.innerHTML = '<p class="text-center">No items found.</p>';

              items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'col-md-4';

                const badgeClass = item.status === 'OPEN'
                        ? 'bg-warning' : (item.status === 'MATCHED' ? 'bg-success' : 'bg-secondary');

                const typeBadgeClass = item.type === 'lost'
                        ? 'btn btn-sm btn-danger ms-2' : 'btn btn-sm btn-success ms-2';

                const typeLabel = item.type === 'lost' ? 'Lost' : 'Found';

                card.innerHTML = `
                    <div class="card shadow-sm search-card">
                        <img src="${item.imagePath || '/images/placeholder.png'}" alt="${item.title}">
                        <div class="card-body">
                            <h5 class="card-title">${item.title}</h5>
                            <p class="card-text">${item.description || 'No description'}<br>
                              <small>${item.location || 'Unknown'}</small></p>
                            <p><strong>Date:</strong> ${item.eventDate ? new Date(item.eventDate).toLocaleDateString() : 'Unknown'}</p>
                            <span class="badge ${badgeClass}">${item.status}</span>
                            <button class="btn btn-sm btn-danger mt-2 delete-btn"
                                    data-id="${item.id}" data-type="${item.type}">Delete</button>
                            <span class="${typeBadgeClass} mt-2">${typeLabel}</span>
                        </div>
                    </div>
                `;
                searchResults.appendChild(card);
              });

              // Delete button with corrected API
              document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {

                  if (!confirm(`Are you sure to delete this ${this.dataset.type} item?`)) return;

                  fetch(`/api/items/delete/${this.dataset.type}/${this.dataset.id}`, {
                    method: 'DELETE'
                  })
                          .then(res => res.text())
                          .then(msg => {
                            alert(msg);
                            loadItems(category, location);
                          })
                          .catch(err => console.error(err));
                });
              });

            })
            .catch(err => console.error("Search error:", err));
  }

  // Initial load
  window.onload = () => loadItems();

  // On search submit
  searchForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const category = document.getElementById('categorySelect').value.toLowerCase();
    const location = document.getElementById('locationInput').value;
    loadItems(category, location);
  });

</script>

</body>
</html>
